const a2_0xb3e588=a2_0x215d;(function(_0x185c4d,_0x33d792){const _0xaf3f30=a2_0x215d,_0x254804=_0x185c4d();while(!![]){try{const _0x38aaec=-parseInt(_0xaf3f30(0x1e1))/0x1*(parseInt(_0xaf3f30(0x1c2))/0x2)+-parseInt(_0xaf3f30(0x1df))/0x3+parseInt(_0xaf3f30(0x1f0))/0x4+-parseInt(_0xaf3f30(0x1e4))/0x5+parseInt(_0xaf3f30(0x1e9))/0x6+parseInt(_0xaf3f30(0x1d6))/0x7+parseInt(_0xaf3f30(0x1d0))/0x8*(-parseInt(_0xaf3f30(0x1ef))/0x9);if(_0x38aaec===_0x33d792)break;else _0x254804['push'](_0x254804['shift']());}catch(_0x1dd630){_0x254804['push'](_0x254804['shift']());}}}(a2_0x3725,0xeae5a));import{dom}from'./dom.js';import{state,updateState}from'./state.js';import{MAX_MESSAGES_PER_SESSION,HISTORY_WINDOW_SIZE}from'./config.js';import{STRINGS}from'./localization.js';const GOOGLE_SCRIPT_URL=a2_0xb3e588(0x1d3);export function initializeChatSystem(){const _0x4ebd6c=a2_0xb3e588;dom['chatSendBtn']&&(dom[_0x4ebd6c(0x1de)][_0x4ebd6c(0x1cb)]=handleSendMessage),dom[_0x4ebd6c(0x1f6)]&&(dom['chatInput'][_0x4ebd6c(0x1f1)]=_0x52ad2f=>{const _0x133870=_0x4ebd6c;if(_0x52ad2f[_0x133870(0x1dd)]===_0x133870(0x1dc))handleSendMessage();}),loadChatHistory();}function a2_0x215d(_0x16f772,_0x468a14){_0x16f772=_0x16f772-0x1bc;const _0x37253e=a2_0x3725();let _0x215d26=_0x37253e[_0x16f772];return _0x215d26;}export function loadChatHistory(){const _0x303cd1=a2_0xb3e588;if(!dom[_0x303cd1(0x1e0)])return;dom[_0x303cd1(0x1e0)][_0x303cd1(0x1ed)]='';if(state[_0x303cd1(0x1d4)]['length']===0x0){addMessageToUI('AI\x20Guide',_0x303cd1(0x1cc),'ai');return;}state[_0x303cd1(0x1d4)][_0x303cd1(0x1c1)](_0x5081f5=>{const _0x4c6d98=_0x303cd1;addMessageToUI(_0x5081f5[_0x4c6d98(0x1ee)]===_0x4c6d98(0x1ce)?_0x4c6d98(0x1d9):_0x4c6d98(0x1bf),_0x5081f5['content'],_0x5081f5[_0x4c6d98(0x1ee)]);});}function a2_0x3725(){const _0x43ca5a=['You\x20have\x20','value','AI\x20Guide','reply','forEach','1406jEJXVP','div','appendChild','scrollHeight','json','bg-white\x20border\x20text-gray-800\x20self-end','placeholder','jejak_session','getItem','onclick','Hello!\x20Ask\x20me\x20anything\x20about\x20the\x20heritage\x20sites.','userMessageCount','user','limitReached','240MeybfW','getElementById','scrollTop','https://script.google.com/macros/s/AKfycbz_77vCq2X7WzGisX9s8Y8mJ8_vXQ8n6J8n-0C0-0C-0C0C0C0/exec','chatHistory','textContent','12486271CqLgQr','bg-blue-100\x20text-blue-900\x20self-start','className','You','/api/chat','token','Enter','key','chatSendBtn','1412382DwaqYB','chatHistoryEl','283lmbuBM','chatLimitText','deviceId','2053980vzgzDk','stringify','POST','</div>\x0a\x20\x20\x20\x20','typing-','7352286GnKuCi','Network\x20error.\x20Please\x20check\x20your\x20connection.','p-3\x20rounded-lg\x20max-w-xs\x20shadow-sm\x20','trim','innerHTML','role','484470nUELAJ','2593772abJlgA','onkeypress','disabled','slice','jejak_chat_history','application/json','chatInput','now'];a2_0x3725=function(){return _0x43ca5a;};return a2_0x3725();}export function addMessageToUI(_0x56dfea,_0x53604b,_0x10073e){const _0x82dd34=a2_0xb3e588;if(!dom[_0x82dd34(0x1e0)])return;const _0x21360d=document['createElement'](_0x82dd34(0x1c3));_0x21360d[_0x82dd34(0x1d8)]=_0x82dd34(0x1eb)+(_0x10073e===_0x82dd34(0x1ce)?_0x82dd34(0x1c7):_0x82dd34(0x1d7));const _0x3190cb=typeof marked!=='undefined'&&_0x10073e==='ai'?marked['parse'](_0x53604b):_0x53604b;_0x21360d[_0x82dd34(0x1ed)]='\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22font-bold\x20text-sm\x22>'+_0x56dfea+'</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22chat-content\x20prose\x20prose-sm\x22>'+_0x3190cb+_0x82dd34(0x1e7),dom[_0x82dd34(0x1e0)][_0x82dd34(0x1c4)](_0x21360d),dom[_0x82dd34(0x1e0)][_0x82dd34(0x1d2)]=dom[_0x82dd34(0x1e0)][_0x82dd34(0x1c5)];}export async function handleSendMessage(){const _0x3b4ba3=a2_0xb3e588,_0x194ff3=dom[_0x3b4ba3(0x1f6)][_0x3b4ba3(0x1be)][_0x3b4ba3(0x1ec)]();if(!_0x194ff3)return;if(state['userMessageCount']>=MAX_MESSAGES_PER_SESSION){alert(STRINGS['chat'][_0x3b4ba3(0x1cf)]);return;}dom['chatInput'][_0x3b4ba3(0x1be)]='',addMessageToUI('You',_0x194ff3,'user');const _0x38d680=[...state[_0x3b4ba3(0x1d4)],{'role':_0x3b4ba3(0x1ce),'content':_0x194ff3}];updateState(_0x3b4ba3(0x1d4),_0x38d680,'jejak_chat_history');const _0x57ca0d=state[_0x3b4ba3(0x1cd)]+0x1;updateState('userMessageCount',_0x57ca0d,'jejak_message_count'),updateChatUIWithCount();const _0x284684=_0x3b4ba3(0x1e8)+Date[_0x3b4ba3(0x1bc)]();addTypingIndicator(_0x284684);try{const _0x4a4fd7=JSON['parse'](localStorage[_0x3b4ba3(0x1ca)](_0x3b4ba3(0x1c9))),_0x18a5f6=_0x4a4fd7?.[_0x3b4ba3(0x1db)],_0x711b0=await fetch(_0x3b4ba3(0x1da),{'method':_0x3b4ba3(0x1e6),'headers':{'Content-Type':_0x3b4ba3(0x1f5)},'body':JSON[_0x3b4ba3(0x1e5)]({'token':_0x18a5f6,'userQuery':_0x194ff3,'history':_0x38d680[_0x3b4ba3(0x1f3)](-HISTORY_WINDOW_SIZE),'deviceId':state[_0x3b4ba3(0x1e3)]})}),_0x3b1cc3=await _0x711b0[_0x3b4ba3(0x1c6)]();removeTypingIndicator(_0x284684);if(_0x3b1cc3[_0x3b4ba3(0x1c0)]){addMessageToUI(_0x3b4ba3(0x1bf),_0x3b1cc3[_0x3b4ba3(0x1c0)],'ai');const _0x1b8e02=[..._0x38d680,{'role':'ai','content':_0x3b1cc3['reply']}];updateState(_0x3b4ba3(0x1d4),_0x1b8e02,_0x3b4ba3(0x1f4));}else addMessageToUI(_0x3b4ba3(0x1bf),'Sorry,\x20I\x20encountered\x20an\x20error.\x20Please\x20try\x20again.','ai');}catch(_0x111d21){removeTypingIndicator(_0x284684),addMessageToUI(_0x3b4ba3(0x1bf),_0x3b4ba3(0x1ea),'ai');}}function addTypingIndicator(_0x46775d){const _0x3ac391=a2_0xb3e588,_0x20c5bc=document['createElement'](_0x3ac391(0x1c3));_0x20c5bc['id']=_0x46775d,_0x20c5bc['className']='p-3\x20rounded-lg\x20bg-blue-50\x20text-blue-400\x20self-start\x20text-xs\x20animate-pulse',_0x20c5bc[_0x3ac391(0x1d5)]='AI\x20is\x20thinking...',dom[_0x3ac391(0x1e0)][_0x3ac391(0x1c4)](_0x20c5bc),dom['chatHistoryEl']['scrollTop']=dom[_0x3ac391(0x1e0)][_0x3ac391(0x1c5)];}function removeTypingIndicator(_0x54fb41){const _0x202965=a2_0xb3e588,_0x5d56dd=document[_0x202965(0x1d1)](_0x54fb41);if(_0x5d56dd)_0x5d56dd['remove']();}export function updateChatUIWithCount(){const _0x3af229=a2_0xb3e588;if(!dom[_0x3af229(0x1e2)])return;const _0x48e7fb=MAX_MESSAGES_PER_SESSION-state['userMessageCount'];dom[_0x3af229(0x1e2)][_0x3af229(0x1d5)]=_0x3af229(0x1bd)+_0x48e7fb+'\x20messages\x20remaining\x20today.',_0x48e7fb<=0x0&&(dom[_0x3af229(0x1f6)][_0x3af229(0x1f2)]=!![],dom['chatSendBtn'][_0x3af229(0x1f2)]=!![],dom['chatInput'][_0x3af229(0x1c8)]='Daily\x20limit\x20reached.');}